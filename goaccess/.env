# ----------------------------------------------------------------------
# GoAccess ç’°å¢ƒè¨­å®šæª”ç¯„æœ¬ (v3.1 - DB-IP)
#
# ä½¿ç”¨æ–¹å¼:
# 1. è¤‡è£½æ­¤æª”æ¡ˆç‚º .env (cp .env.example .env)
# 2. æ ¹æ“šæ‚¨çš„éœ€æ±‚ä¿®æ”¹ä»¥ä¸‹è®Šæ•¸ã€‚
# 3. æ‰€æœ‰ GoAccess çš„åŠŸèƒ½éƒ½ç”± GOACCESS_OPTS é€™ä¸€å€‹è®Šæ•¸é›†ä¸­æ§åˆ¶ã€‚
# ----------------------------------------------------------------------

# --- åŸºç¤è¨­å®š (å¿…å¡«) ---

# æ™‚å€è¨­å®š (ä¾‹å¦‚: Asia/Shanghai, UTC)
TZ=${TZ:-Asia/Taipei}

# GoAccess å°å¤–æœå‹™çš„ Web UI é€£æ¥åŸ 
GOACCESS_PORT=7890

# WebSocket é€£ç·š URL (æ¥µç‚ºé‡è¦ï¼Œè«‹å¡«å¯«æ‚¨çš„å…¬é–‹ç¶²åŸŸæˆ–IP)
GOACCESS_WS_URL=*

# --- æ—¥èªŒåˆ†æè¨­å®š (å¿…å¡«) ---

# è¦åˆ†æçš„æ—¥èªŒæª”å (æ”¯æ´è¬ç”¨å­—å…ƒ *)
LOG_FILE=*_access.log

# ----------------------------------------------------------------------
# --- å…¨åŠŸèƒ½æ§åˆ¶ä¸­å¿ƒ (GOACCESS_OPTS) ---
# ----------------------------------------------------------------------
#
# å°‡æ‰€æœ‰æ‚¨éœ€è¦çš„ GoAccess å‘½ä»¤åˆ—åƒæ•¸å…¨éƒ¨å¯«åœ¨é€™è£¡ï¼Œç”¨ç©ºæ ¼éš”é–‹ã€‚
# é€™æ˜¯æ§åˆ¶ GoAccess è¡Œç‚ºçš„å”¯ä¸€å…¥å£é»ã€‚
# GeoIP è³‡æ–™åº«æœƒç”± compose è‡ªå‹•åµæ¸¬ä¸¦åŠ å…¥ï¼Œç„¡éœ€åœ¨æ­¤è¨­å®šã€‚
#
# ä»¥ä¸‹æ˜¯ä¸€å€‹åŒ…å«æ‰€æœ‰å¸¸ç”¨åŠŸèƒ½çš„å®Œæ•´ç¯„ä¾‹ã€‚
# æ‚¨å¯ä»¥æ ¹æ“šéœ€è¦ï¼Œè¤‡è£½ã€åˆªé™¤æˆ–ä¿®æ”¹å…¶ä¸­çš„ä»»ä½•éƒ¨åˆ†ï¼Œä¾†çµ„æˆæ‚¨è‡ªå·±çš„è¨­å®šã€‚
# ç‚ºäº†å¯è®€æ€§ï¼Œç¯„ä¾‹ä½¿ç”¨äº† `\` é€²è¡Œæ›è¡Œï¼Œæ‚¨ä¹Ÿå¯ä»¥å°‡æ‰€æœ‰åƒæ•¸å¯«åœ¨åŒä¸€è¡Œã€‚
#
# ----------------------------------------------------------------------

GOACCESS_OPTS="\
  --log-format='%h %^[%d:%t %^] \"%r\" %s %b \"%R\" \"%u\"' \
  --time-format='%H:%M:%S' \
  --date-format='%d/%b/%Y' \
  --html-report-title='DF Awesome Server Stats' \
  --html-prefs='{\"theme\":\"darkly\"}' \
  --sort-panel=VISITORS,BY_HITS,DESC \
  --max-items=256 \
  --persist \
  --restore \
  --keep-last=365 \
  --444-as-404 \
  --4xx-to-unique-count \
  --jobs=4 \
"

# --- GOACCESS_OPTS åƒæ•¸è©³ç´°è¨»è§£ (ä¾›æ‚¨åƒè€ƒ) ---
#
# --- ä»¥ä¸‹ç‚ºå¯é¸åƒæ•¸ï¼Œæ‚¨å¯ä»¥å°‡éœ€è¦çš„è¡Œè¤‡è£½åˆ°ä¸Šé¢çš„ GOACCESS_OPTS ä¸­ ---
#
# --ignore-ip=127.0.0.1
# --ignore-crawler='Googlebot'
# --ignore-crawler='bingbot'
# --ignore-status=401
# --ignore-referrer='*.spam.com'
#
# ----------------------------------------------------------------------
# GoAccess Docker Compose - v3.2 (DB-IP å…¨è‡ªå‹•å®‰å…¨ç‰ˆ)
version: "3.8"

services:
  goaccess:
    image: allinurl/goaccess:latest
    container_name: goaccess
    restart: unless-stopped
    ports:
      - "${GOACCESS_PORT:-7890}:7890"
    volumes:
      # æ›è¼‰æ•´å€‹è³‡æ–™ç›®éŒ„ï¼Œçµ±ä¸€ç®¡ç†å ±å‘Šã€è³‡æ–™åº«å’Œ GeoIP æª”æ¡ˆ
      - "${DATA_PATH:-/mnt/appdata/goaccess}:/goaccess/data"
      # ä»¥å”¯è®€æ¨¡å¼æ›è¼‰æ—¥èªŒä¾†æºç›®éŒ„
      - "${NGINX_LOG_PATH}:/srv/logs:ro"
    env_file:
      - ./.env
    entrypoint:
      - /bin/sh
      - -c
      - |
        set -e
        echo "ğŸš€ æ­£åœ¨åˆå§‹åŒ– GoAccess (v3.2 - DB-IP)..."

        # --- 1. è‡ªå‹•ä¸‹è¼‰ GeoIP è³‡æ–™åº« (DB-IP) ---
        DB_DIR="/goaccess/data/geoip"
        # æª¢æŸ¥ä»»ä¸€æª”æ¡ˆä¸å­˜åœ¨æ™‚ï¼Œå°±è§¸ç™¼ä¸‹è¼‰
        if [ ! -f "$DB_DIR/dbip-city-lite.mmdb" ] || [ ! -f "$DB_DIR/dbip-asn-lite.mmdb" ]; then
          echo "ğŸŒ æ­£åœ¨ä¸‹è¼‰æœ€æ–°çš„ DB-IP GeoIP è³‡æ–™åº« (å…è²»ç‰ˆ)..."
          mkdir -p "$DB_DIR"
          CURRENT_YM=$(date +%Y-%m)
          # ä½¿ç”¨ curl ä¸‹è¼‰ä¸¦è§£å£“
          curl -L "https://download.db-ip.com/free/dbip-city-lite-${CURRENT_YM}.mmdb.gz" | gunzip > "$DB_DIR/dbip-city-lite.mmdb"
          curl -L "https://download.db-ip.com/free/dbip-asn-lite-${CURRENT_YM}.mmdb.gz" | gunzip > "$DB_DIR/dbip-asn-lite.mmdb"
          echo "âœ… GeoIP è³‡æ–™åº«å·²å°±ç·’ã€‚"
        else
          echo "âœ… GeoIP è³‡æ–™åº«å·²å­˜åœ¨ï¼Œç•¥éä¸‹è¼‰ã€‚"
        fi

        # --- 2. çµ„åˆä¸¦åŸ·è¡Œæœ€çµ‚å‘½ä»¤ (å®‰å…¨æ¨¡å¼) ---
        # çµ„åˆå›ºå®šçš„æ ¸å¿ƒåƒæ•¸
        FIXED_ARGS="--output=/goaccess/data/report.html --real-time-html --addr=0.0.0.0 --port=7890 --daemonize --pid-file=/goaccess/data/goaccess.pid --db-path=/goaccess/data/"
        [ -f "$DB_DIR/dbip-city-lite.mmdb" ] && FIXED_ARGS="$FIXED_ARGS --geoip-database=$DB_DIR/dbip-city-lite.mmdb"
        [ -f "$DB_DIR/dbip-asn-lite.mmdb" ] && FIXED_ARGS="$FIXED_ARGS --geoip-database=$DB_DIR/dbip-asn-lite.mmdb"

        echo "--------------------------------------------------"
        echo "ğŸš€ æ­£åœ¨å•Ÿå‹• GoAccess..."
        echo "æ—¥èªŒä¾†æº: /srv/logs/${LOG_FILE}"
        echo "è‡ªè¨‚åƒæ•¸: ${GOACCESS_OPTS}"
        echo "--------------------------------------------------"

        # ä½¿ç”¨ set -- å’Œ exec ä¾†å®‰å…¨åœ°è™•ç†åƒæ•¸ï¼Œé¿å… eval å¸¶ä¾†çš„é¢¨éšª
        # $GOACCESS_OPTS æœƒè¢« shell å®‰å…¨åœ°åˆ†å‰²æˆç¨ç«‹çš„åƒæ•¸
        set -- ${GOACCESS_OPTS}
        exec goaccess "/srv/logs/${LOG_FILE}" "$@" ${FIXED_ARGS}

    command: [] # command ç•™ç©ºï¼Œå› ç‚ºæ‰€æœ‰å‘½ä»¤å·²ç”± entrypoint å…¨æ¬Šè™•ç†
```
### å•Ÿå‹•æµç¨‹è©³è§£

1.  **åˆå§‹åŒ–**: å®¹å™¨å•Ÿå‹•æ™‚ï¼ŒåŸ·è¡Œ `entrypoint` ä¸­çš„ shell è…³æœ¬ã€‚
2.  **GeoIP è³‡æ–™åº«æª¢æŸ¥èˆ‡ä¸‹è¼‰ (DB-IP)**:
   - è…³æœ¬æœƒæª¢æŸ¥æŒä¹…åŒ–ç›®éŒ„ `/goaccess/data/geoip` ä¸­æ˜¯å¦å­˜åœ¨ DB-IP çš„è³‡æ–™åº«æª”æ¡ˆ (`dbip-city-lite.mmdb`, `dbip-asn-lite.mmdb`)ã€‚
   - å¦‚æœæª”æ¡ˆ**ä¸å­˜åœ¨**ï¼Œå®ƒæœƒä½¿ç”¨ `curl` è‡ªå‹•å¾ DB-IP çš„å®˜æ–¹ä¸‹è¼‰é»ç²å–ç•¶æœˆæœ€æ–°çš„å…è²»ç‰ˆè³‡æ–™åº«ï¼Œä¸¦è§£å£“ç¸®ã€‚
   - å¦‚æœæª”æ¡ˆå·²å­˜åœ¨ï¼Œå‰‡æœƒè·³éä¸‹è¼‰ï¼Œé¿å…ä¸å¿…è¦çš„ç¶²è·¯è«‹æ±‚ã€‚è‹¥æ‚¨æƒ³å¼·åˆ¶æ›´æ–°ï¼Œå¯ä»¥æ‰‹å‹•åˆªé™¤ä¸»æ©Ÿä¸Šå°æ‡‰çš„ `.mmdb` æª”æ¡ˆå¾Œé‡å•Ÿå®¹å™¨ã€‚
3.  **å‹•æ…‹å‘½ä»¤çµ„åˆ**:
   - **æ—¥èªŒä¾†æº**: `goaccess /srv/logs/${LOG_FILE}` - æŒ‡å‘æ‚¨æ›è¼‰çš„æ—¥èªŒæª”ï¼ˆæ³¨æ„è·¯å¾‘å·²æ›´æ–°ç‚º `/srv/logs`ï¼‰ã€‚
   - **ä½¿ç”¨è€…è‡ªè¨‚åƒæ•¸**: `${GOACCESS_OPTS}` - å°‡æ‚¨åœ¨ `.env` ä¸­è¨­å®šçš„æ‰€æœ‰ GoAccess åƒæ•¸åŸå°ä¸å‹•åœ°åŠ åˆ°å‘½ä»¤åˆ—ä¸­ã€‚
   - **æ ¸å¿ƒå›ºå®šåƒæ•¸**: `FIXED_ARGS` - åŒ…å«å¿…è¦çš„åƒæ•¸ï¼Œä¸¦è‡ªå‹•åŠ ä¸Šå‰›å‰›ä¸‹è¼‰å¥½çš„ DB-IP è³‡æ–™åº«è·¯å¾‘ã€‚
4.  **å®‰å…¨åŸ·è¡Œå‘½ä»¤**: è…³æœ¬æœ€å¾Œæœƒä½¿ç”¨ `set --` å’Œ `exec` ä¾†çµ„åˆä¸¦åŸ·è¡Œ `goaccess` å‘½ä»¤ã€‚é€™ç¨®æ–¹æ³•æ¯” `eval` æ›´å®‰å…¨ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢æ½›åœ¨çš„ shell æ³¨å…¥é¢¨éšªï¼ŒåŒæ™‚èƒ½æ­£ç¢ºè™•ç†å¸¶æœ‰ç©ºæ ¼æˆ–ç‰¹æ®Šå­—å…ƒçš„åƒæ•¸ã€‚

é€™ç¨®è¨­è¨ˆçš„å¥½è™•æ˜¯ï¼Œ`docker-compose.yml` æª”æ¡ˆæœ¬èº«è®Šå¾—éå¸¸ç©©å®šï¼Œå¹¾ä¹ä¸éœ€è¦ä¿®æ”¹ã€‚æœªä¾†è‹¥è¦æ–°å¢æˆ–èª¿æ•´ GoAccess çš„ä»»ä½•åŠŸèƒ½ï¼Œæ‚¨**åªéœ€è¦å°ˆæ³¨æ–¼ä¿®æ”¹ `.env` æª”æ¡ˆä¸­çš„ `GOACCESS_OPTS` è®Šæ•¸å³å¯**ï¼Œå¯¦ç¾äº†è¨­å®šèˆ‡æ¶æ§‹çš„å®Œå…¨åˆ†é›¢ã€‚

## ğŸ“š å¦‚ä½•æ‰¾åˆ° Nginx Proxy Manager (NPM) çš„æ—¥èªŒè·¯å¾‘

è¦è®“ GoAccess åˆ†ææ‚¨çš„ç¶²ç«™æµé‡ï¼Œé¦–å…ˆéœ€è¦æ‰¾åˆ° Nginx Proxy Manager (NPM) å„²å­˜ `access.log` çš„ä½ç½®ã€‚é€™é€šå¸¸åœ¨æ‚¨éƒ¨ç½² NPM çš„ `docker-compose.yml` ä¸­å®šç¾©ã€‚

1. **æ‰¾åˆ° NPM çš„ `docker-compose.yml`**ï¼šé€™å€‹æª”æ¡ˆé€šå¸¸åœ¨æ‚¨ç•¶åˆè¨­å®š NPM çš„ç›®éŒ„ä¸‹ï¼Œä¾‹å¦‚ `/some/path/to/your/npm/docker-compose.yml`ã€‚

2. **å°‹æ‰¾ `logs` æ›è¼‰å·**ï¼šåœ¨è©²æª”æ¡ˆä¸­ï¼Œæ‰¾åˆ° `services` -> `app` -> `volumes` å€å¡Šã€‚æ‚¨æœƒçœ‹åˆ°é¡ä¼¼é€™æ¨£çš„è¨­å®šï¼š
```yaml
services:
     app:
       # ... å…¶ä»–è¨­å®š ...
       volumes:
         - ./data:/data
         - ./letsencrypt:/etc/letsencrypt
         - ./logs:/data/logs  # <--- é€™å°±æ˜¯æˆ‘å€‘è¦æ‰¾çš„ï¼
```
3. **ç¢ºå®šä¸»æ©Ÿè·¯å¾‘**ï¼š
   - åœ¨é€™å€‹ä¾‹å­ä¸­ï¼Œ`./logs:/data/logs` çš„æ„æ€æ˜¯ï¼Œä¸»æ©Ÿä¸Šç›¸å°æ–¼ `docker-compose.yml` çš„ `logs` ç›®éŒ„ï¼Œè¢«æ›è¼‰åˆ°äº† NPM å®¹å™¨å…§çš„ `/data/logs`ã€‚
   - å› æ­¤ï¼ŒNPM ç”¢ç”Ÿçš„æ‰€æœ‰ access logï¼Œå¯¦éš›ä¸Šéƒ½å„²å­˜åœ¨æ‚¨ä¸»æ©Ÿçš„ `./logs` ç›®éŒ„ä¸­ã€‚
   - æ‚¨éœ€è¦å–å¾—é€™å€‹ç›®éŒ„çš„**çµ•å°è·¯å¾‘**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„ NPM compose æª”æ¡ˆåœ¨ `/root/stacks/npm/docker-compose.yml`ï¼Œé‚£éº¼æ—¥èªŒçš„çµ•å°è·¯å¾‘å°±æ˜¯ `/root/stacks/npm/logs`ã€‚

4. **å¡«å…¥ `.env` æª”æ¡ˆ**ï¼š
   - å°‡æ‚¨æ‰¾åˆ°çš„çµ•å°è·¯å¾‘å¡«å…¥ GoAccess çš„ `.env` æª”æ¡ˆä¸­ï¼š
```env
NGINX_LOG_PATH=/root/stacks/npm/logs
```
cker-compose.yml`ï¼Œé‚£éº¼æ—¥èªŒçš„çµ•å°è·¯å¾‘å°±æ˜¯ `/root/stacks/npm/logs`ã€‚

4. **å¡«å…¥ `.env` æª”æ¡ˆ**ï¼š
   - å°‡æ‚¨æ‰¾åˆ°çš„çµ•å°è·¯å¾‘å¡«å…¥ GoAccess çš„ `.env` æª”æ¡ˆä¸­ï¼š
```env
NGINX_LOG_PATH=/root/stacks/npm/logs
```
