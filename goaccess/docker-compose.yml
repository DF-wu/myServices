# GoAccess Docker Compose - v3.0 (æ¥µè‡´ç°¡æ½”èˆ‡å®Œå…¨æ§åˆ¶)
# æ­¤æª”æ¡ˆç‚ºæœ€çµ‚ç°¡åŒ–ç‰ˆï¼Œå°ˆæ³¨æ–¼å®šç¾©æœå‹™æ¶æ§‹ã€‚
# GoAccess çš„æ‰€æœ‰è¡Œç‚ºéƒ½ç”± .env æª”æ¡ˆä¸­çš„ GOACCESS_OPTS è®Šæ•¸å®Œå…¨æ§åˆ¶ã€‚
version: "3.8"

services:
  goaccess:
    image: allinurl/goaccess:latest
    container_name: goaccess
    restart: unless-stopped
    ports:
      - "7890:7890"
    volumes:
      # æ›è¼‰æ•´å€‹è³‡æ–™ç›®éŒ„ï¼Œçµ±ä¸€ç®¡ç†å ±å‘Šã€è³‡æ–™åº«å’Œ GeoIP æª”æ¡ˆ
      - "/mnt/appdata/goaccess:/goaccess/data"
      # ä»¥å”¯è®€æ¨¡å¼æ›è¼‰æ—¥èªŒä¾†æºç›®éŒ„
      - "${NGINX_LOG_PATH}:/opt/logs:ro"
    env_file:
      - .env
    entrypoint:
      - /bin/sh
      - -c
      - |
        set -e
        echo "ğŸš€ æ­£åœ¨åˆå§‹åŒ– GoAccess (v3.2 - DB-IP with curl)..."

        # --- 1. è‡ªå‹•ä¸‹è¼‰ GeoIP è³‡æ–™åº« (DB-IP) ---
        DB_DIR="/goaccess/data/geoip"
        # DB-IP Lite databases are updated monthly. We check if they exist.
        # To force an update, user can manually delete the .mmdb files.
        if [ ! -f "$DB_DIR/dbip-city-lite.mmdb" ] || [ ! -f "$DB_DIR/dbip-asn-lite.mmdb" ]; then
          echo "ğŸŒ æ­£åœ¨ä½¿ç”¨ curl ä¸‹è¼‰æœ€æ–°çš„ DB-IP GeoIP è³‡æ–™åº« (å…è²»ç‰ˆ)..."
          mkdir -p "$DB_DIR"
          CURRENT_YM=$(date +%Y-%m)
          # Download City Lite DB
          curl -sL "https://download.db-ip.com/free/dbip-city-lite-${CURRENT_YM}.mmdb.gz" -o "$DB_DIR/dbip-city-lite.mmdb.gz" && gunzip -f "$DB_DIR/dbip-city-lite.mmdb.gz"
          # Download ASN Lite DB
          curl -sL "https://download.db-ip.com/free/dbip-asn-lite-${CURRENT_YM}.mmdb.gz" -o "$DB_DIR/dbip-asn-lite.mmdb.gz" && gunzip -f "$DB_DIR/dbip-asn-lite.mmdb.gz"
          echo "âœ… GeoIP è³‡æ–™åº«å·²å°±ç·’ã€‚"
        else
          echo "âœ… GeoIP è³‡æ–™åº«å·²å­˜åœ¨ï¼Œç•¥éä¸‹è¼‰ã€‚"
        fi

        # --- 2. çµ„åˆä¸¦åŸ·è¡Œæœ€çµ‚å‘½ä»¤ ---
        # çµ„åˆå›ºå®šçš„æ ¸å¿ƒåƒæ•¸
        FIXED_ARGS="--output=/goaccess/data/report.html --real-time-html --addr=0.0.0.0 --port=7890 --daemonize --pid-file=/goaccess/data/goaccess.pid --db-path=/goaccess/data/"
        [ -f "$DB_DIR/dbip-city-lite.mmdb" ] && FIXED_ARGS="$FIXED_ARGS --geoip-database=$DB_DIR/dbip-city-lite.mmdb"
        [ -f "$DB_DIR/dbip-asn-lite.mmdb" ] && FIXED_ARGS="$FIXED_ARGS --geoip-database=$DB_DIR/dbip-asn-lite.mmdb"

        # çµ„åˆæœ€çµ‚å‘½ä»¤: goaccess <æ—¥èªŒæª”> <.envä¸­çš„æ‰€æœ‰è‡ªè¨‚åƒæ•¸> <å›ºå®šçš„æ ¸å¿ƒåƒæ•¸>
        CMD="goaccess /opt/logs/${LOG_FILE} ${GOACCESS_OPTS} ${FIXED_ARGS}"

        echo "--------------------------------------------------"
        echo "æœ€çµ‚åŸ·è¡Œçš„å‘½ä»¤ç‚º:"
        echo "$CMD"
        echo "--------------------------------------------------"
        eval "exec $CMD"

    command: [] # command ç•™ç©ºï¼Œå› ç‚ºæ‰€æœ‰å‘½ä»¤å·²ç”± entrypoint å…¨æ¬Šè™•ç†
