# GoAccess on Docker: å…¨è‡ªå‹•åŒ–éƒ¨ç½²æ–¹æ¡ˆ
#
# --- é‡è¦æç¤º ---
# - æ­¤ Compose æª”æ¡ˆä¸­çš„æ‰€æœ‰ `${VAR}` è®Šæ•¸éƒ½æ‡‰åœ¨ `.env` æª”æ¡ˆä¸­å®šç¾©ã€‚
# - Entrypoint è…³æœ¬ä¸­çš„æ‰€æœ‰ `$$VAR` æˆ– `$${VAR}` å¯«æ³•æ˜¯ç‚ºäº†é˜²æ­¢ Docker Compose é€²è¡Œè®Šæ•¸æ›¿æ›ï¼Œ å› çˆ²compose æœƒåœ¨è®€å–compose fileéšæ®µå°±æŠŠè®Šæ•¸æ›¿æ›æ‰ã€‚
# å› æ­¤é€ æˆ mkdir ç­‰å‘½ä»¤ç„¡æ³•æ­£ç¢ºåŸ·è¡Œã€‚ å› çˆ²GEOIP_DIR ç­‰è®Šæ•¸åœ¨å¯¦éš›ä¸Šåœ¨è®€å–composeæª”æ¡ˆæ™‚å°±å·²ç¶“è¢«æ›¿æ›äº†ã€‚
# æ‰€ä»¥åœ¨ entrypoint è…³æœ¬ä¸­ä½¿ç”¨ `$$` æˆ– `$${}` ä¾†ç¢ºä¿è®Šæ•¸èƒ½æ­£ç¢ºå‚³éåˆ°å®¹å™¨å…§çš„ shell ç’°å¢ƒã€‚
# ç¢ºä¿ `$` ç¬¦è™Ÿèƒ½è¢«æ­£ç¢ºå‚³éåˆ°å®¹å™¨å…§çš„ shell ç’°å¢ƒä¸­ã€‚
#
services:
  goaccess:
    image: allinurl/goaccess:latest
    container_name: goaccess
    restart: unless-stopped
    user: root
    ports:
      - "7890:7890"
    volumes:
      # æ›è¼‰æ•´å€‹è³‡æ–™ç›®éŒ„ï¼Œçµ±ä¸€ç®¡ç†å ±å‘Šã€è³‡æ–™åº«å’Œ GeoIP æª”æ¡ˆ
      - "/mnt/appdata/goaccess:/goaccess/data"
      # ä»¥å”¯è®€æ¨¡å¼æ›è¼‰æ—¥èªŒä¾†æºç›®éŒ„
      - "/mnt/appdata/NginxProxyManager/logs:/srv/logs:ro"
    env_file:
      - ./.env
    entrypoint:
      - /bin/sh
      - -c
      - |
        set -ex
        echo "ğŸš€ æ­£åœ¨åˆå§‹åŒ– GoAccess (v3.2 - DB-IP)..."

        # --- 1. è‡ªå‹•ä¸‹è¼‰ GeoIP è³‡æ–™åº« (DB-IP) ---
        GEOIP_DIR="/goaccess/data/geoip"
        # æª¢æŸ¥ä»»ä¸€æª”æ¡ˆä¸å­˜åœ¨æ™‚ï¼Œå°±è§¸ç™¼ä¸‹è¼‰
        if [ ! -f "$$GEOIP_DIR/dbip-city-lite.mmdb" ] || [ ! -f "$$GEOIP_DIR/dbip-asn-lite.mmdb" ]; then
          echo "ğŸŒ æ­£åœ¨ä¸‹è¼‰æœ€æ–°çš„ DB-IP GeoIP è³‡æ–™åº« (å…è²»ç‰ˆ)..."
          mkdir -p "$$GEOIP_DIR"
          CURRENT_YM=$$(date +%Y-%m)
          # ä½¿ç”¨ curl ä¸‹è¼‰ä¸¦è§£å£“
          curl -L "https://download.db-ip.com/free/dbip-city-lite-$${CURRENT_YM}.mmdb.gz" | gunzip > "$$GEOIP_DIR/dbip-city-lite.mmdb"
          curl -L "https://download.db-ip.com/free/dbip-asn-lite-$${CURRENT_YM}.mmdb.gz" | gunzip > "$$GEOIP_DIR/dbip-asn-lite.mmdb"
          echo "âœ… GeoIP è³‡æ–™åº«å·²å°±ç·’ã€‚"
        else
          echo "âœ… GeoIP è³‡æ–™åº«å·²å­˜åœ¨ï¼Œç•¥éä¸‹è¼‰ã€‚"
        fi

        # --- 2. çµ„åˆä¸¦åŸ·è¡Œæœ€çµ‚å‘½ä»¤ (å®‰å…¨æ¨¡å¼) ---
        # çµ„åˆå›ºå®šçš„æ ¸å¿ƒåƒæ•¸ (å·²ç§»é™¤ --daemonize å’Œ --pid-file)
        FIXED_ARGS="--output=/goaccess/data/report.html --real-time-html --addr=0.0.0.0 --port=7890 --db-path=/goaccess/data/"
        [ -f "$$GEOIP_DIR/dbip-city-lite.mmdb" ] && FIXED_ARGS="$$FIXED_ARGS --geoip-database=$$GEOIP_DIR/dbip-city-lite.mmdb"
        [ -f "$$GEOIP_DIR/dbip-asn-lite.mmdb" ] && FIXED_ARGS="$$FIXED_ARGS --geoip-database=$$GEOIP_DIR/dbip-asn-lite.mmdb"

        echo "--------------------------------------------------"
        echo "ğŸš€ æ­£åœ¨ä»¥å‰æ™¯æ¨¡å¼å•Ÿå‹• GoAccess..."
        echo "æ—¥èªŒä¾†æº: /srv/logs/$${LOG_FILE}"
        echo "è‡ªè¨‚åƒæ•¸: $${GOACCESS_OPTS}"
        echo "--------------------------------------------------"

        # ç›´æ¥åŸ·è¡Œ GoAccessï¼Œä¸ä½¿ç”¨ execï¼Œä¸¦ç§»é™¤è·¯å¾‘çš„å¼•è™Ÿ
        # é€™è®“ shell æœ‰æ©Ÿæœƒæ“´å±•æ—¥èªŒè·¯å¾‘ä¸­çš„è¬ç”¨å­—å…ƒ (*)
        goaccess /srv/logs/$${LOG_FILE} $${GOACCESS_OPTS} $${FIXED_ARGS}

    command: [] # command ç•™ç©ºï¼Œå› ç‚ºæ‰€æœ‰å‘½ä»¤å·²ç”± entrypoint å…¨æ¬Šè™•ç†
