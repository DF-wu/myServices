version: "3.8"

services:
  goaccess:
    image: allinurl/goaccess:latest
    container_name: goaccess
    restart: unless-stopped
    user: root
    ports:
      - "7890:7890"
    volumes:
      # æ›è¼‰æ•´å€‹è³‡æ–™ç›®éŒ„ï¼Œçµ±ä¸€ç®¡ç†å ±å‘Šã€è³‡æ–™åº«å’Œ GeoIP æª”æ¡ˆ
      - "/mnt/appdata/goaccess:/goaccess/data"
      # ä»¥å”¯è®€æ¨¡å¼æ›è¼‰æ—¥èªŒä¾†æºç›®éŒ„
      - "/mnt/appdata/NginxProxyManager/logs:/srv/logs:ro"
    env_file:
      - ./.env
    entrypoint:
      - /bin/sh
      - -c
      - |
        set -ex
        echo "ğŸš€ æ­£åœ¨åˆå§‹åŒ– GoAccess (v3.2 - DB-IP)..."

        # --- 1. è‡ªå‹•ä¸‹è¼‰ GeoIP è³‡æ–™åº« (DB-IP) ---
        GEOIP_DIR="/goaccess/data/geoip"
        # æª¢æŸ¥ä»»ä¸€æª”æ¡ˆä¸å­˜åœ¨æ™‚ï¼Œå°±è§¸ç™¼ä¸‹è¼‰
        if [ ! -f "$$GEOIP_DIR/dbip-city-lite.mmdb" ] || [ ! -f "$$GEOIP_DIR/dbip-asn-lite.mmdb" ]; then
          echo "ğŸŒ æ­£åœ¨ä¸‹è¼‰æœ€æ–°çš„ DB-IP GeoIP è³‡æ–™åº« (å…è²»ç‰ˆ)..."
          mkdir -p "$$GEOIP_DIR"
          CURRENT_YM=$$(date +%Y-%m)
          # ä½¿ç”¨ curl ä¸‹è¼‰ä¸¦è§£å£“
          curl -L "https://download.db-ip.com/free/dbip-city-lite-$${CURRENT_YM}.mmdb.gz" | gunzip > "$$GEOIP_DIR/dbip-city-lite.mmdb"
          curl -L "https://download.db-ip.com/free/dbip-asn-lite-$${CURRENT_YM}.mmdb.gz" | gunzip > "$$GEOIP_DIR/dbip-asn-lite.mmdb"
          echo "âœ… GeoIP è³‡æ–™åº«å·²å°±ç·’ã€‚"
        else
          echo "âœ… GeoIP è³‡æ–™åº«å·²å­˜åœ¨ï¼Œç•¥éä¸‹è¼‰ã€‚"
        fi

        # --- 2. çµ„åˆä¸¦åŸ·è¡Œæœ€çµ‚å‘½ä»¤ (å®‰å…¨æ¨¡å¼) ---
        # çµ„åˆå›ºå®šçš„æ ¸å¿ƒåƒæ•¸
        FIXED_ARGS="--output=/goaccess/data/report.html --real-time-html --addr=0.0.0.0 --port=7890 --daemonize --pid-file=/goaccess/data/goaccess.pid --db-path=/goaccess/data/"
        [ -f "$$GEOIP_DIR/dbip-city-lite.mmdb" ] && FIXED_ARGS="$$FIXED_ARGS --geoip-database=$$GEOIP_DIR/dbip-city-lite.mmdb"
        [ -f "$$GEOIP_DIR/dbip-asn-lite.mmdb" ] && FIXED_ARGS="$$FIXED_ARGS --geoip-database=$$GEOIP_DIR/dbip-asn-lite.mmdb"

        echo "--------------------------------------------------"
        echo "ğŸš€ æ­£åœ¨å•Ÿå‹• GoAccess..."
        echo "æ—¥èªŒä¾†æº: /srv/logs/$${LOG_FILE}"
        echo "è‡ªè¨‚åƒæ•¸: $${GOACCESS_OPTS}"
        echo "--------------------------------------------------"

        # ä½¿ç”¨ exec ç›´æ¥åŸ·è¡Œï¼Œå–ä»£ç›®å‰çš„ shell ç¨‹åºã€‚
        # è®“ shell è‡ªå‹•å° GOACCESS_OPTS é€²è¡Œå–®è©åˆ†å‰²ä¾†å‚³éåƒæ•¸ã€‚
        # é€™ç¨®å¯«æ³•æ›´ç‚ºé€šç”¨å’Œç›´è§€ï¼ŒåŒæ™‚ä¿ç•™äº† exec å¸¶ä¾†çš„ç¨‹åºç®¡ç†å„ªå‹¢ã€‚
        exec goaccess "/srv/logs/$${LOG_FILE}" $${GOACCESS_OPTS} $${FIXED_ARGS}

    command: [] # command ç•™ç©ºï¼Œå› ç‚ºæ‰€æœ‰å‘½ä»¤å·²ç”± entrypoint å…¨æ¬Šè™•ç†
