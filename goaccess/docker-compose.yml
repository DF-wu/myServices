# GoAccess on Docker: å…¨è‡ªå‹•åŒ–éƒ¨ç½²æ–¹æ¡ˆ
#
# ç‰ˆæœ¬: 4.0 (2025-07-07)
# è¨­è¨ˆè€…: chufei & Copilot
#
# --- è¨­è¨ˆå“²å­¸ ---
# 1.  **é›¶æ‰‹å‹•ä»‹å…¥**: éƒ¨ç½²éç¨‹ç„¡éœ€åœ¨ä¸»æ©Ÿä¸Šæ‰‹å‹•å»ºç«‹ä»»ä½•æª”æ¡ˆã€ç›®éŒ„æˆ–åŸ·è¡Œå‰ç½®è…³æœ¬ã€‚
# 2.  **.env é©…å‹•**: æ‰€æœ‰å¯è®Šåƒæ•¸ï¼ˆè·¯å¾‘ã€é€£æ¥åŸ ã€GoAccess é¸é …ï¼‰å…¨éƒ¨æŠ½é›¢è‡³ .env æª”æ¡ˆï¼ŒCompose æª”æ¡ˆæœ¬èº«ä¿æŒç©©å®šï¼Œä¸è¼•æ˜“æ”¹å‹•ã€‚
# 3.  **é–‹ç®±å³ç”¨**: å®¹å™¨å•Ÿå‹•æ™‚ï¼Œæ‰€æœ‰å¤–éƒ¨ä¾è³´ï¼ˆå¦‚ GeoIP è³‡æ–™åº«ï¼‰æ‡‰è‡ªå‹•ä¸‹è¼‰ä¸¦é…ç½®ã€‚
# 4.  **å®‰å…¨èˆ‡å¥å£¯**: è…³æœ¬æ‡‰æ¡ç”¨æœ€ä½³å¯¦è¸ï¼Œé¿å…å¸¸è¦‹çš„ shell é¢¨éšªï¼ˆå¦‚ eval æ³¨å…¥ï¼‰ï¼Œä¸¦åœ¨åµéŒ¯æ¨¡å¼ä¸‹ï¼ˆset -xï¼‰æä¾›æ¸…æ™°çš„åŸ·è¡Œéç¨‹ã€‚
#
# --- æ ¸å¿ƒåŠŸèƒ½ ---
# - **å…¨è‡ªå‹• GeoIP**: ç„¡éœ€è¨»å†Šæˆ– API é‡‘é‘°ã€‚å®¹å™¨å•Ÿå‹•æ™‚æœƒè‡ªå‹•å¾ DB-IP ä¸‹è¼‰æœ€æ–°çš„å…è²»åŸå¸‚å’Œ ASN è³‡æ–™åº«ã€‚
# - **å‹•æ…‹å‘½ä»¤ç”Ÿæˆ**: Entrypoint è…³æœ¬æœƒæ ¹æ“š .env ä¸­çš„è¨­å®šï¼Œå®‰å…¨åœ°çµ„åˆæœ€çµ‚çš„ GoAccess åŸ·è¡Œå‘½ä»¤ã€‚
# - **æŒä¹…åŒ–**: å ±å‘Šã€æ­·å²è³‡æ–™åº«å’Œ GeoIP æª”æ¡ˆçµ±ä¸€å„²å­˜åœ¨æ›è¼‰çš„è³‡æ–™å·ä¸­ï¼Œç¢ºä¿è³‡æ–™ä¸éºå¤±ã€‚
# - **æ¥µç°¡ç¶­è­·**: æœªä¾†å‡ç´šæˆ–èª¿æ•´ GoAccess åŠŸèƒ½ï¼Œåªéœ€ä¿®æ”¹ .env ä¸­çš„ GOACCESS_OPTS è®Šæ•¸å³å¯ã€‚
#
# --- é‡è¦æç¤º ---
# - æ­¤ Compose æª”æ¡ˆä¸­çš„æ‰€æœ‰ `${VAR}` è®Šæ•¸éƒ½æ‡‰åœ¨ `.env` æª”æ¡ˆä¸­å®šç¾©ã€‚
# - Entrypoint è…³æœ¬ä¸­çš„æ‰€æœ‰ `$$VAR` æˆ– `$${VAR}` å¯«æ³•æ˜¯ç‚ºäº†é˜²æ­¢ Docker Compose é€²è¡Œè®Šæ•¸æ›¿æ›ï¼Œ
#   ç¢ºä¿ `$` ç¬¦è™Ÿèƒ½è¢«æ­£ç¢ºå‚³éåˆ°å®¹å™¨å…§çš„ shell ç’°å¢ƒä¸­ã€‚
#
services:
  goaccess:
    image: allinurl/goaccess:latest
    container_name: goaccess
    restart: unless-stopped
    user: root
    ports:
      - "7890:7890"
    volumes:
      # æ›è¼‰æ•´å€‹è³‡æ–™ç›®éŒ„ï¼Œçµ±ä¸€ç®¡ç†å ±å‘Šã€è³‡æ–™åº«å’Œ GeoIP æª”æ¡ˆ
      - "/mnt/appdata/goaccess:/goaccess/data"
      # ä»¥å”¯è®€æ¨¡å¼æ›è¼‰æ—¥èªŒä¾†æºç›®éŒ„
      - "/mnt/appdata/NginxProxyManager/logs:/srv/logs:ro"
    env_file:
      - ./.env
    entrypoint:
      - /bin/sh
      - -c
      - |
        set -ex
        echo "ğŸš€ æ­£åœ¨åˆå§‹åŒ– GoAccess (v3.2 - DB-IP)..."

        # --- 1. è‡ªå‹•ä¸‹è¼‰ GeoIP è³‡æ–™åº« (DB-IP) ---
        GEOIP_DIR="/goaccess/data/geoip"
        # æª¢æŸ¥ä»»ä¸€æª”æ¡ˆä¸å­˜åœ¨æ™‚ï¼Œå°±è§¸ç™¼ä¸‹è¼‰
        if [ ! -f "$$GEOIP_DIR/dbip-city-lite.mmdb" ] || [ ! -f "$$GEOIP_DIR/dbip-asn-lite.mmdb" ]; then
          echo "ğŸŒ æ­£åœ¨ä¸‹è¼‰æœ€æ–°çš„ DB-IP GeoIP è³‡æ–™åº« (å…è²»ç‰ˆ)..."
          mkdir -p "$$GEOIP_DIR"
          CURRENT_YM=$$(date +%Y-%m)
          # ä½¿ç”¨ curl ä¸‹è¼‰ä¸¦è§£å£“
          curl -L "https://download.db-ip.com/free/dbip-city-lite-$${CURRENT_YM}.mmdb.gz" | gunzip > "$$GEOIP_DIR/dbip-city-lite.mmdb"
          curl -L "https://download.db-ip.com/free/dbip-asn-lite-$${CURRENT_YM}.mmdb.gz" | gunzip > "$$GEOIP_DIR/dbip-asn-lite.mmdb"
          echo "âœ… GeoIP è³‡æ–™åº«å·²å°±ç·’ã€‚"
        else
          echo "âœ… GeoIP è³‡æ–™åº«å·²å­˜åœ¨ï¼Œç•¥éä¸‹è¼‰ã€‚"
        fi

        # --- 2. çµ„åˆä¸¦åŸ·è¡Œæœ€çµ‚å‘½ä»¤ (å®‰å…¨æ¨¡å¼) ---
        # çµ„åˆå›ºå®šçš„æ ¸å¿ƒåƒæ•¸
        FIXED_ARGS="--output=/goaccess/data/report.html --real-time-html --addr=0.0.0.0 --port=7890 --daemonize --pid-file=/goaccess/data/goaccess.pid --db-path=/goaccess/data/"
        [ -f "$$GEOIP_DIR/dbip-city-lite.mmdb" ] && FIXED_ARGS="$$FIXED_ARGS --geoip-database=$$GEOIP_DIR/dbip-city-lite.mmdb"
        [ -f "$$GEOIP_DIR/dbip-asn-lite.mmdb" ] && FIXED_ARGS="$$FIXED_ARGS --geoip-database=$$GEOIP_DIR/dbip-asn-lite.mmdb"

        echo "--------------------------------------------------"
        echo "ğŸš€ æ­£åœ¨å•Ÿå‹• GoAccess..."
        echo "æ—¥èªŒä¾†æº: /srv/logs/$${LOG_FILE}"
        echo "è‡ªè¨‚åƒæ•¸: $${GOACCESS_OPTS}"
        echo "--------------------------------------------------"

        # ä½¿ç”¨ exec ç›´æ¥åŸ·è¡Œï¼Œå–ä»£ç›®å‰çš„ shell ç¨‹åºã€‚
        # è®“ shell è‡ªå‹•å° GOACCESS_OPTS é€²è¡Œå–®è©åˆ†å‰²ä¾†å‚³éåƒæ•¸ã€‚
        # é€™ç¨®å¯«æ³•æ›´ç‚ºé€šç”¨å’Œç›´è§€ï¼ŒåŒæ™‚ä¿ç•™äº† exec å¸¶ä¾†çš„ç¨‹åºç®¡ç†å„ªå‹¢ã€‚
        exec goaccess "/srv/logs/$${LOG_FILE}" $${GOACCESS_OPTS} $${FIXED_ARGS}

    command: [] # command ç•™ç©ºï¼Œå› ç‚ºæ‰€æœ‰å‘½ä»¤å·²ç”± entrypoint å…¨æ¬Šè™•ç†
