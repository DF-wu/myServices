name: Daily Lottery Automation

on:
  schedule:
    # 每天 UTC 0:00 运行（北京时间 8:00）
    - cron: "0 0 * * *"
  workflow_dispatch:
    # 允许手动触发

env:
  LOTTERY_URL: ""  # 在腳本中動態組裝

jobs:
  lottery:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      flaresolverr:
        image: ghcr.io/flaresolverr/flaresolverr:latest
        ports:
          - 8191:8191
        env:
          LOG_LEVEL: info
          CAPTCHA_SOLVER: none

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: 安装依赖
        run: |
          cd _CRONJOBS/lottery-automation
          npm install

      - name: 安装 Playwright 浏览器
        run: npx playwright install chromium

      - name: 等待 FlareSolverr 启动
        run: |
          echo "等待 FlareSolverr 服务启动..."
          for i in {1..30}; do
            if curl -s http://localhost:8191/health > /dev/null 2>&1; then
              echo "✅ FlareSolverr 已就绪"
              break
            fi
            echo "等待中... ($i/30)"
            sleep 2
          done

      - name: 运行抽奖脚本
        id: lottery
        continue-on-error: true
        env:
          LOTTERY_URL: ${{ env.LOTTERY_URL }}
          LINUXDO_COOKIES: ${{ secrets.LINUXDO_COOKIES }}
          CONNECT_COOKIES: ${{ secrets.CONNECT_COOKIES }}
          FLARESOLVERR_URL: http://localhost:8191/v1
        run: |
          cd _CRONJOBS/lottery-automation
          node lottery-auto.js 2>&1 | tee lottery-output.log
          exit ${PIPESTATUS[0]}

      - name: 显示完整日志（如果失败）
        if: steps.lottery.outcome == 'failure'
        run: |
          cd _CRONJOBS/lottery-automation
          echo "=== 完整错误日志 ==="
          cat lottery-output.log || echo "无法读取日志文件"
          echo ""
          echo "=== 截图文件列表 ==="
          ls -lh screenshots/ 2>/dev/null || echo "没有截图文件"

      - name: 上传截图（如果失败）
        if: steps.lottery.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: lottery-screenshots-${{ github.run_number }}
          path: _CRONJOBS/lottery-automation/screenshots/
          retention-days: 7
          if-no-files-found: warn
