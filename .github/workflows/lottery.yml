name: è–„è·å…¬ç›Šç«™è‡ªåŠ¨æŠ½å¥–

on:
  schedule:
    # æ¯å¤© UTC 0:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  LOTTERY_URL: 'https://qd.x666.me'

jobs:
  lottery:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      flaresolverr:
        image: ghcr.io/flaresolverr/flaresolverr:latest
        ports:
          - 8191:8191
        env:
          LOG_LEVEL: info
          CAPTCHA_SOLVER: none

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…ä¾èµ–
        run: npm install

      - name: å®‰è£… Playwright æµè§ˆå™¨
        run: npx playwright install chromium

      - name: ç­‰å¾… FlareSolverr å¯åŠ¨
        run: |
          echo "ç­‰å¾… FlareSolverr æœåŠ¡å¯åŠ¨..."
          for i in {1..30}; do
            if curl -s http://localhost:8191/health > /dev/null 2>&1; then
              echo "âœ… FlareSolverr å·²å°±ç»ª"
              break
            fi
            echo "ç­‰å¾…ä¸­... ($i/30)"
            sleep 2
          done

      - name: è¿è¡ŒæŠ½å¥–è„šæœ¬
        env:
          LINUXDO_COOKIES: ${{ secrets.LINUXDO_COOKIES }}
          FLARESOLVERR_URL: http://localhost:8191/v1
        run: node lottery-auto.js

      - name: ä¸Šä¼ æˆªå›¾ï¼ˆå¦‚æžœå¤±è´¥ï¼‰
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots
          path: screenshots/
          retention-days: 7

      - name: åˆ›å»ºå¤±è´¥é€šçŸ¥ Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueTitle = 'ðŸŽ° æŠ½å¥–è‡ªåŠ¨åŒ–å¤±è´¥ - ' + new Date().toISOString().split('T')[0];
            const issueBody = `
            ## æŠ½å¥–ä»»åŠ¡å¤±è´¥

            **æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}

            **å·¥ä½œæµè¿è¡Œ**: [æŸ¥çœ‹è¯¦æƒ…](${context.payload.repository.html_url}/actions/runs/${context.runId})

            ### å¯èƒ½åŽŸå› 
            - Cookie å·²è¿‡æœŸï¼Œéœ€è¦æ›´æ–° GitHub Secrets ä¸­çš„ LINUXDO_COOKIES
            - ç½‘ç«™ç»´æŠ¤æˆ–æ— æ³•è®¿é—®
            - å·²ç»æŠ½è¿‡å¥–äº†
            - é¡µé¢ç»“æž„å‘ç”Ÿå˜åŒ–

            ### è§£å†³æ–¹æ³•
            1. æ£€æŸ¥å·¥ä½œæµæ—¥å¿—
            2. æŸ¥çœ‹ä¸Šä¼ çš„é”™è¯¯æˆªå›¾
            3. å¿…è¦æ—¶æ›´æ–° Cookie
            `;

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä»Šå¤©çš„ issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['lottery-automation']
            });

            const todayIssue = issues.data.find(issue => issue.title === issueTitle);

            if (!todayIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['lottery-automation', 'bug']
              });
            }
